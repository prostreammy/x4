<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Stream Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        video { width: 90%; max-width: 1000px; background: #000; }
    </style>
</head>
<body>
    <video id="video" controls autoplay muted></video>

    <script>
        async function initPlayer() {
            const video = document.getElementById('video');
            const player = new shaka.Player(video);

            player.configure({
                streaming: {
                    bufferingGoal: 4,          // Minimal buffer for fast start
                    rebufferingGoal: 1,        // Resume fast
                    lowLatencyMode: true
                },
                manifest: {
                    dash: {
                        // IGNORE server-suggested 10-20s delay
                        ignoreSuggestedPresentationDelay: true,
                        autoCorrectDrift: true
                    }
                }
            });

            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                const BASE = "https://load.perfecttv.net/mpd/bola1/";
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {
                    request.uris = ["/api/proxy"];
                } else if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    const uri = request.uris[0];
                    if (!uri.startsWith('http') || uri.includes(window.location.hostname)) {
                        request.uris = [BASE + uri.split('/').pop()];
                    }
                }
            });

            try {
                await player.load('manifest.mpd');
                
                // FORCE JUMP TO LIVE EDGE
                // This fixes the "Black Screen / No Playback" issue
                const seekRange = player.seekRange();
                video.currentTime = seekRange.end - 2; // Seek to 2s before the very end
                
                video.play();
                console.log("Jumping to live edge:", seekRange.end);
            } catch (e) {
                console.error("Load Error:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            shaka.polyfill.installAll();
            initPlayer();
        });
    </script>
</body>
</html>
