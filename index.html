<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>High Performance Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <style>
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        video { width: 100%; max-width: 900px; background: #111; }
    </style>
</head>
<body>
    <video id="video" controls autoplay></video>

    <script>
        async function initPlayer() {
            const video = document.getElementById('video');
            const player = new shaka.Player(video);

            // 1. Optimization Config
            player.configure({
                streaming: {
                    bufferingGoal: 12,      // Larger buffer to absorb network spikes
                    rebufferingGoal: 3,
                    jumpLargeGaps: true
                },
                manifest: {
                    dash: { autoCorrectDrift: true }
                }
            });

            // 2. NETWORK FILTER (The Speed Fix)
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                const PROXY_URL = "/api/proxy";
                const ORIGIN_BASE = "https://load.perfecttv.net/mpd/bola1/";

                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {
                    // Only the manifest goes through Vercel
                    request.uris = [PROXY_URL];
                } else if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    // Segments go DIRECTLY to the source server (Bypassing Vercel)
                    // We manually fix the URL if it looks like a relative path
                    if (!request.uris[0].startsWith('http')) {
                        request.uris = [ORIGIN_BASE + request.uris[0]];
                    }
                }
            });

            try {
                // We start with a dummy string because the filter handles the real URL
                await player.load('manifest.mpd');
            } catch (e) {
                console.error("Load error", e);
            }
        }
        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
</html>
